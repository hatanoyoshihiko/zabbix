---
# Create initial database
- name: Start MariaDB Server
  systemd:
    name: mariadb-server.service
    state: start
    enabled: yes

- name: Wait for MariaDB Server Service
  wait_for:
    host: "{{ ansible_host }}"
    port: 3306
    delay: 10
    state: started

- name: Set root user password
  mysql_user:
    login_user: "{{ mysql.root }}"
    login_password: ""
    name: "{{ mysql.root }}"
    password: "{{ mysql.root.password }}"
    check_implicit_admin: yes
    state: present

- name: Delete anonymous user
  mysql_user:
    login_user: "{{ mysql.root }}"
    login_password: "{{ mysql.root.password }}"
    name: ""
    host_all: yes
    state: absent

- name: Create database
  mysql_db:
    login_user: "{{ mysql.root }}"
    login_password: "{{ mysql.root.password }}"
    name: "{{ db_name }}"
    state: present
    encoding: utf8mb4

- name: Create zabbix user
  mysql_user:
    login_user: "{{ mysql.root }}"
    login_password: "{{ mysql.root.password }}"
    name: "{{ mysql.user}}"
    password: "{{ mysql.user.password }}"
    priv: "{{ mysql.user }}.*:ALL"
    state: present

- name: Set DB config file mariadb-server.cnf
  template:
    src: mariadb-server.cnf.j2
    dest: /etc/my.cnf.d/mariadb-server.cnf
    owner: root
    group: root
    mode: "0644"

- name: Set DB config file clients.cnf
  template:
    src: clients.cnf.j2
    dest: /etc/my.cnf.d/clients.cnf
    owner: root
    group: root
    mode: "0644"

- name: Start MariaDB Server
  systemd:
    name: mariadb-server.service
    state: restart

- name: Wait for MariaDB Server Service
  wait_for:
    host: "{{ ansible_host }}"
    port: 3306
    delay: 10
    state: started

- name: import initial schema and data
  command: zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql "-u{{ mysql.user }}" -p "{{ mysql.user.password }}"

- name: Set Zabbix Server config file
  template:
    src: zabbix_server.conf
    dest: /etc/zabbix/zabbix_server.conf
    owner: root
    group: root
    mode: "0600"

- name: Restart service
  systemd:
    name: "{{ zabbix_services }}"
    vars:
      zabbix_services:
        - zabbix-server
        - zabbix-agent
        - httpd
        - php-fpm
    state: restart
    enabled: yes

- name: Wait for MariaDB Server Service
  wait_for:
    host: "{{ ansible_host }}"
    port: 80
    delay: 10
    state: started

- debug:
    msg: Access to http://"{{ ansible_host }}"/zabbix/
# - debug:
#     msg: 'file id {{item.item.path}} (name {{item.item.logname}}) exists'
#   with_items: "{{ log_file.results }}"
#   when: item.stat.exists
